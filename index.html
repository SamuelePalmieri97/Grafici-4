<script>
  let opzioni = [];
  let colori = ['green', 'red', 'blue', 'orange', 'purple', 'brown', 'cyan', 'magenta'];

  function aggiungiOpzione() {
    const strike = parseFloat(document.getElementById("strike").value);
    const premio = parseFloat(document.getElementById("premio").value);
    const quantita = parseInt(document.getElementById("quantita").value);
    const scadenza = parseInt(document.getElementById("scadenza").value);
    const posizione = document.getElementById("posizione").value;

    if (isNaN(strike) || isNaN(premio) || isNaN(quantita) || isNaN(scadenza)) {
      alert("Inserisci tutti i valori numerici!");
      return;
    }

    opzioni.push({ strike, premio, quantita, scadenza, tipo: "call", posizione });
    aggiornaTabella();
    aggiornaGrafico();
  }

  function rimuoviOpzione(index) {
    opzioni.splice(index, 1);
    aggiornaTabella();
    aggiornaGrafico();
  }

  function aggiornaTabella() {
    const tbody = document.querySelector("#tabellaOpzioni tbody");
    tbody.innerHTML = "";
    opzioni.forEach((opzione, i) => {
      const row = `<tr>
        <td>${opzione.strike}</td>
        <td>${opzione.premio}</td>
        <td>${opzione.quantita}</td>
        <td>${opzione.scadenza} gg</td>
        <td>${opzione.posizione}</td>
        <td><button onclick="rimuoviOpzione(${i})">Rimuovi</button></td>
      </tr>`;
      tbody.innerHTML += row;
    });
  }

  function calcolaPayoffOpzione(opzione, prezzi) {
    return prezzi.map(p => {
      let payoff = Math.max(0, p - opzione.strike) - opzione.premio;
      if (opzione.posizione === "short") payoff = -payoff;
      return payoff * opzione.quantita;
    });
  }

  function aggiornaGrafico() {
    const prezzoAttuale = parseFloat(document.getElementById("prezzo").value);
    const prezzi = [];
    const min = prezzoAttuale - 50, max = prezzoAttuale + 50, step = 5;
    for (let p = min; p <= max; p += step) prezzi.push(p);

    const datasets = [];
    let payoffTotale = prezzi.map(() => 0);

    opzioni.forEach((opzione, idx) => {
      const payoff = calcolaPayoffOpzione(opzione, prezzi);
      payoffTotale = payoffTotale.map((val, i) => val + payoff[i]);

      datasets.push({
        label: `Call ${opzione.posizione} @${opzione.strike} (${opzione.scadenza}gg)`, // ‚Üê CORRETTO QUI
        data: payoff,
        borderColor: colori[idx % colori.length],
        borderWidth: 2,
        fill: false
      });
    });

    datasets.push({
      label: "Payoff Totale",
      data: payoffTotale,
      borderColor: "black",
      borderWidth: 2,
      borderDash: [5, 5],
      fill: false
    });

    const ctx = document.getElementById("graficoPayoff").getContext("2d");
    if (window.chart) window.chart.destroy();

    window.chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: prezzi,
        datasets: datasets
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: true
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: "Prezzo Sottostante"
            }
          },
          y: {
            title: {
              display: true,
              text: "Payoff"
            }
          }
        }
      }
    });
  }
</script>
